---
title: LOJ2351_JOI2018Final 毒蛇越狱_毒蛇の出走_Snake Escaping 题解
date: 2023-09-26 09:39:35
tags: 题解
description: LOJ2351_JOI2018Final 毒蛇越狱_毒蛇の出走_Snake Escaping 题解
mathjax: true
---

### 题意

给你 $2^L$ 个长为 $L$ 的 $0/1$ 串，第 $i$ 个串为 $i$ 的二进制表达，每个串有权值 $a_i$。$q$ 次询问，每次给你一个长为 $L$ 的串，其由 $0/1/?$ 构成。求将 $?$ 换成任意的 $0/1$ 之后，所有 可能与给定的询问串相同的串 的权值之和。 

### 题解

本文中的 $\&,|$ 分别表示二进制与运算，二进制或运算。

考虑一个给定的询问串。

记 $cnt_0,cnt_1,cnt_2$ 分别表示 $0,1,?$ 在询问串的个数，$all_0,all_1,all_2$ 表示询问串中 $0,1,?$ 的位置，如 $L=3$，询问串为 $01?$，则 $all_0=100,all_1=010,all_2=001$。由于 $cnt_0+cnt_1+cnt_2\le 20$，所以 $\min\{cnt_0 , cnt_1 , cnt_2\} \le 6$，对这三种情况分类讨论。

- 若 $cnt_2\le 6$

  直接暴力枚举每一个 $?$ 填什么，给总答案加上对应的 $0/1$ 串的权值。时间复杂度 $O(2^{cnt_2})$。

- 若 $cnt_0\le 6$

  记 $f1_i=\sum_{i|j=j}a_j$。此时：

  - 若 $cnt_0=0$，则答案为 $f1_{all_1}$。
  - 若 $cnt_0=1$，则答案为 $f1_{all_1}-f1_{all_1|all_0}$，即用钦定 $all_1$ 的所有位置填 $1$ 的方案数减去本来是 $0$ 的位置填了 $1$ 的方案数。

  这启示我们考虑容斥，用钦定 $all_1$ 的位置填 $1$ 的方案数，减去 $all_0$ 的位置填了 $1$ 的方案数。因为 $cnt_0\le 6$ 所以直接枚举哪些本来是 $0$ 的位置填了 $1$ 即可，即枚举 $all_0$  的子集。即答案为：
  $$
  \sum_{i|all_0=all_0,popcount(i)\&1=0} f1_{all_1|i}-\sum_{i|all_0=all_0,popcount(i)\&1=1}f1_{all_1|i}
  $$
  时间复杂度 $O(2^{cnt_0})$。

- 若 $cnt_1\le 6$

  同 $cnt_0\le 6$，记 $f0_i\sum_{j|i=i}a_j$ ，即 $f0_i$ 表示所有串 $j$ 满足其所有 $0$ 的位置构成的集合是 $i$ 中 $0$ 的位置构成的集合的超集的串 $j$ 的权值和，则答案为：
  $$
  \sum_{i|all_1=all_1,popcount(i)\&1=0} f0_{all_0|i}-\sum_{i|all_1=all_1,popcount(i)\&1=1}f0_{all_0|i}
  $$
  时间复杂度 $O(2^{cnt_1})$。

综上所述，单次询问的时间复杂度为 $O(2^{\lfloor\frac{L}{3}\rfloor})$，考虑上述的 $f0,f1$ 实际上就是一个高维前缀和，预处理的时间复杂度为 $O(2^LL)$，所以总时间复杂度为 $O(2^LL+q2^{\lfloor\frac{L}{3}\rfloor})$，可以通过。

[AC 记录及 Code](https://atcoder.jp/contests/joi2018ho/submissions/45954278)。
